# JWT å®‰å…¨æœºåˆ¶è¯¦è§£

## JWT æ˜¯ä»€ä¹ˆ

JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§ç”¨äºèº«ä»½è®¤è¯çš„ä»¤ç‰Œæ ¼å¼ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

```
Header.Payload.Signature
```

## Supabase JWT å†…å®¹ç¤ºä¾‹

```json
// Headerï¼ˆè§£ç åï¼‰
{
  "alg": "HS256",
  "typ": "JWT"
}

// Payloadï¼ˆè§£ç åï¼‰
{
  "aud": "authenticated",
  "exp": 1706400000,
  "sub": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "phone": "",
  "app_metadata": {
    "provider": "email",
    "providers": ["email"]
  },
  "user_metadata": {},
  "role": "authenticated"
}
```

## ä¸ºä»€ä¹ˆ JWT ä¸èƒ½è¢«ä¼ªé€ 

```
ç­¾åå…¬å¼ï¼š
Signature = HMAC-SHA256(
    Base64URL(Header) + "." + Base64URL(Payload),
    secret_key  â† åªæœ‰æœåŠ¡å™¨çŸ¥é“
)
```

æ”»å‡»è€…å¯ä»¥çœ‹åˆ° Header å’Œ Payloadï¼ˆå®ƒä»¬åªæ˜¯ Base64 ç¼–ç ï¼‰ï¼Œä½†ï¼š
- âŒ æ— æ³•ä¿®æ”¹å†…å®¹ï¼ˆç­¾åéªŒè¯ä¼šå¤±è´¥ï¼‰
- âŒ æ— æ³•ä¼ªé€ æ–° Tokenï¼ˆä¸çŸ¥é“ secret_keyï¼‰

## ä¸­é—´äººæ”»å‡»é˜²æŠ¤

### ä¼ è¾“å±‚å®‰å…¨ï¼ˆHTTPSï¼‰

```
ç”¨æˆ· â†â”€â”€â”€â”€ TLS åŠ å¯†éš§é“ â”€â”€â”€â”€â†’ æœåŠ¡å™¨
           â”‚
           æ”»å‡»è€…åªèƒ½çœ‹åˆ°
           åŠ å¯†åçš„ä¹±ç 
```

### Token å­˜å‚¨å®‰å…¨

| å­˜å‚¨æ–¹å¼ | å®‰å…¨æ€§ | XSS é£é™© | CSRF é£é™© |
|----------|--------|----------|-----------|
| localStorage | ä¸­ | ğŸ”´ æ˜“å—æ”»å‡» | ğŸŸ¢ å®‰å…¨ |
| sessionStorage | ä¸­ | ğŸ”´ æ˜“å—æ”»å‡» | ğŸŸ¢ å®‰å…¨ |
| HttpOnly Cookie | é«˜ | ğŸŸ¢ å®‰å…¨ | ğŸ”´ éœ€é˜²æŠ¤ |
| å†…å­˜ | é«˜ | ğŸŸ¢ å®‰å…¨ | ğŸŸ¢ å®‰å…¨ |

Supabase é»˜è®¤ä½¿ç”¨ **localStorage**ï¼Œè¿™æ˜¯æƒè¡¡äº†ç”¨æˆ·ä½“éªŒåçš„é€‰æ‹©ã€‚

### é˜²æŠ¤ XSS æ”»å‡»

```javascript
// 1. å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰
// åœ¨ nginx.conf ä¸­æ·»åŠ 
add_header Content-Security-Policy "default-src 'self'; script-src 'self'" always;

// 2. React è‡ªåŠ¨è½¬ä¹‰ HTML
// ä»¥ä¸‹ä»£ç æ˜¯å®‰å…¨çš„ï¼š
<div>{userInput}</div>  // è‡ªåŠ¨è½¬ä¹‰

// âš ï¸ å±é™©æ“ä½œï¼š
<div dangerouslySetInnerHTML={{__html: userInput}} />  // ä¸è¦è¿™æ ·åš
```

## æœ€ä½³å®è·µ

### 1. Token è¿‡æœŸæ—¶é—´

```javascript
// Supabase é»˜è®¤é…ç½®
Access Token: 1 å°æ—¶
Refresh Token: 1 å‘¨

// æ•æ„Ÿæ“ä½œå»ºè®®ï¼š
// - é‡æ–°éªŒè¯èº«ä»½
// - ä½¿ç”¨çŸ­æœŸ Token
```

### 2. ç™»å‡ºæ—¶æ¸…ç†

```javascript
// æ­£ç¡®çš„ç™»å‡ºæ–¹å¼
const { error } = await supabase.auth.signOut();

// è¿™ä¼šï¼š
// 1. æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ Token
// 2. ä½¿ Refresh Token å¤±æ•ˆï¼ˆæœåŠ¡ç«¯ï¼‰
```

### 3. æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

```javascript
// ä¿®æ”¹å¯†ç ã€ç»‘å®šæ‰‹æœºç­‰æ•æ„Ÿæ“ä½œ
// å»ºè®®è¦æ±‚ç”¨æˆ·é‡æ–°è¾“å…¥å¯†ç 

const { data, error } = await supabase.auth.updateUser({
  password: 'new-password'
}, {
  nonce: await getVerificationCode()  // éœ€è¦éªŒè¯ç 
});
```

## å¸¸è§æ”»å‡»åŠé˜²æŠ¤

### 1. Token çªƒå–

| æ”»å‡»æ–¹å¼ | é˜²æŠ¤ |
|----------|------|
| ç½‘ç»œç›‘å¬ | HTTPS + HSTS |
| XSS æ”»å‡» | CSP + è¾“å…¥è¿‡æ»¤ |
| æœ¬åœ°å­˜å‚¨è®¿é—® | æ— æ³•å®Œå…¨é˜²æŠ¤ï¼ˆéœ€ä¿¡ä»»æµè§ˆå™¨ï¼‰ |

### 2. Token é‡æ”¾æ”»å‡»

```
æ”»å‡»è€…ä½¿ç”¨çªƒå–çš„ Token é‡å¤è¯·æ±‚

é˜²æŠ¤ï¼š
- Token è¿‡æœŸæ—¶é—´çŸ­
- æ•æ„Ÿæ“ä½œéœ€è¦é¢å¤–éªŒè¯
- ç›‘æ§å¼‚å¸¸ç™»å½•ï¼ˆIPã€è®¾å¤‡å˜åŒ–ï¼‰
```

### 3. æš´åŠ›ç ´è§£ JWT Secret

```
æ”»å‡»è€…å°è¯•çŒœæµ‹ JWT Secret æ¥ä¼ªé€  Token

é˜²æŠ¤ï¼ˆSupabase å·²å®ç°ï¼‰ï¼š
- ä½¿ç”¨ 256 ä½éšæœºå¯†é’¥
- æš´åŠ›ç ´è§£éœ€è¦æ•°åäº¿å¹´
```

## Supabase å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•

- [ ] å¯ç”¨ RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰
- [ ] é…ç½® HTTPSï¼ˆTLS 1.2+ï¼‰
- [ ] å¯ç”¨ HSTS
- [ ] é…ç½® CSP å¤´
- [ ] å®šæœŸè½®æ¢ JWT Secretï¼ˆå¯é€‰ï¼‰
- [ ] ç›‘æ§å¼‚å¸¸ç™»å½•
- [ ] æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

